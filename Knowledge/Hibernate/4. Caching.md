# Caching

Without caching, Hibernate has to fetch data from the database every time a request is fired. This process can be `time-consuming` and can cause `performance issues`, especially for frequently accessed data. Additionally, as the size of the data grows, the time required to fetch and process the data increases exponentially.

This is where caching comes in. **Caching is a technique that allows frequently accessed data to be stored in memory so that it can be quickly retrieved without having to go back to the database every time**. By caching data, Hibernate can reduce the number of database queries it needs to execute, improving performance and reducing the load on the database server.

## Levels of Caching in Hibernate

Hibernate offers caching at three levels:

### 1. First-Level Cache (also known as Session Cache)

First-level caching is an in-built caching mechanism provided by Hibernate that stores the data in the memory of the Session object. Whenever an entity is fetched from the database, it is stored in the cache. If the same entity is requested again within the same session, Hibernate retrieves it from the cache instead of hitting the database. This can significantly improve the performance of the application by reducing the number of database queries.

The first-level cache has session-level scope, which means that the data stored in the cache is available only within the session. When the session is closed, the cache is cleared automatically. The cache is also not shared between different sessions, which means that each session has its own separate cache.

Hibernate manages the first-level cache automatically, and there is no need to configure it manually. The cache is enabled by default and can’t be turned off. When an entity is fetched from the database, Hibernate checks if it is already present in the cache. If it is, the cached entity is returned, otherwise, Hibernate fetches the entity from the database and stores it in the cache.

## **2. Second-Level Cache**

Second-level caching is an optional caching mechanism provided by Hibernate that stores data across sessions. It is more powerful than first-level caching, which is limited to a single session.

To enable Second-level Caching in Hibernate, you need to configure a cache provider in your Hibernate configuration file. Hibernate supports multiple cache providers such as `Ehcache`, `Infinispan`, and `Hazelcast`. You also need to annotate the entities that you want to cache with the `@Cacheable` annotation. I’ll show an example using `Ehcache`.

1. Add the `Ehcache` dependency in your pom.xml file: 
```
`<dependency>`  
`<groupId>org.hibernate</groupId>`  
`<artifactId>hibernate-ehcache</artifactId>`  
`<version>${hibernate.version}</version>`  
`</dependency>`
```
2. Configure `Ehcache` in your `application.properties` file:
```
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.ehcache.EhCacheRegionFactory`  
`spring.jpa.properties.hibernate.cache.use_second_level_cache=true`
```
3. Annotate Entities:
	To enable caching for an entity, annotate it with the `@Cacheable` annotation. You can also specify the cache concurrency strategy using the `@Cache` annotation.
```
@Data  
@Entity  
@Table(name = "users")  
@Cacheable  
@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)  
public class User {  
	@Id  
	@GeneratedValue(strategy = GenerationType.IDENTITY)  
	private Long id;  
	private String username;  
	private String email;  
}
```

The scope of Second-level Caching in Hibernate is application-level, which means that the cached data is available across multiple sessions.

Hibernate supports **three cache modes** for Second-level Caching: **read-only, read-write, and transactional**. The **read-only** cache mode is used for data that is `not expected to change frequently`. The **read-write** cache mode is used for `data that is frequently updated`. The **transactional** cache mode is used for `data that is updated within a transaction`.

The **cache concurrency strategy** determines **how multiple threads access the cache**. Hibernate supports multiple cache concurrency strategies such as **READ_ONLY**, **NONSTRICT_READ_WRITE**, **READ_WRITE**, and **TRANSACTIONAL**.

**To ensure data consistency**, Hibernate provides a cache synchronization mechanism that automatically updates the cache when the database is updated. This mechanism is called **cache invalidation**. When an entity is updated, Hibernate invalidates the corresponding cache entry, and the next time the entity is accessed, it is fetched from the database and stored in the cache.

---
## **3. Query Cache**

Query caching is a caching mechanism provided by Hibernate to cache the results of queries. When a query is executed, Hibernate checks if the query results are already cached. If the results are found in the cache, they are returned without hitting the database, otherwise, the query is executed and the results are cached for future use.

To enable query caching in Hibernate, you need to set the `hibernate.cache.use_query_cache` property to true.

```
spring.jpa.properties.hibernate.cache.use_query_cache=true  
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.ehcache.EhCacheRegionFactory
```

```
@Repository  
public interface AuthorRepository extends CrudRepository<Author, Integer> {  
	@QueryHints({ @QueryHint(name = "org.hibernate.cacheable", value ="true") })  
	Author findByName(String name);  
}
```
---
# Configuring Caching in Hibernate

Hibernate provides various configuration properties to enable and configure caching. Here are some of the commonly used properties:

1. `hibernate.cache.use_second_level_cache` - Set this to `true` to enable the second-level cache.
2. `hibernate.cache.region.factory_class` - This property specifies the caching provider to be used for the second-level and query cache. For example, to use EHCache, set it to `org.hibernate.cache.ehcache.EhCacheRegionFactory`.
3. `hibernate.cache.use_query_cache` - Set this to `true` to enable the query cache.
4. `hibernate.cache.provider_configuration_file_resource_path` - This property specifies the path to the configuration file for the caching provider. For example, for EHCache, it can be set to `ehcache.xml`.